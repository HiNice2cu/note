# YOLOv5 模型训练

## 一、训练前数据集格式整理（必做步骤）

标注完成后需按 YOLOv5 标准格式整理数据集，确保模型能正确读取图片与标签文件，这是训练成功的基础前提。

### 1. 标准文件夹结构

需创建顶层 `images` 和 `labels` 文件夹，且名称不可修改，内部均划分 `train`（训练集）和 `val`（验证集）子文件夹，结构如下：

```plain text

dataset/
├─ images/       # 存放所有图片
│  ├─ train/     # 训练集图片
│  └─ val/       # 验证集图片
└─ labels/       # 存放所有标注文件（与图片一一对应）
   ├─ train/     # 训练集标签文件
   └─ val/       # 验证集标签文件
```

### 2. 实操整理步骤

1. 数据集划分：因标注图片仅41张，随机抽取部分作为验证集，具体为将编号300至480的7张图片移入 `images/val`，其余图片全部放入 `images/train`。

2. 标签文件同步：在 `labels` 文件夹下创建 `train` 和 `val` 子文件夹，将300至480对应的7个标注文件移入 `labels/val`，剩余标注文件放入 `labels/train`，确保图片与标签文件名完全一致。

3. 辅助文件调整：将自动生成的 `classes.txt` 移至 `dataset` 外层目录。

关键提醒：文件夹名称、文件对应关系必须严格遵循上述规范，否则模型将无法读取数据，导致训练报错。

## 二、核心训练参数配置

YOLOv5 训练仅需重点配置两个核心参数：`weights`（预训练权重）和 `data`（数据集配置文件），参数设置正确即可启动训练。

### 1. 核心参数说明

|参数名称|作用|配置要求|
|---|---|---|
|`weights`|指定预训练权重文件，基于官方模型微调，无需从头训练|与前文检测模块使用的权重文件格式一致（如 `yolov5s.pt`），放置于 YOLOv5 根目录|
|`data`|指定数据集描述文件（.yaml格式），定义数据路径、类别映射|复制官方 `coco128.yaml` 并修改，适配自定义数据集|
### 2. 数据集配置文件（.yaml）修改

#### 步骤1：复制配置文件

进入 YOLOv5 根目录 `data` 文件夹，复制 `coco128.yaml` 并重命名为 `bvn.` `yaml`。

#### 步骤2：修改文件内容

```yaml

# 数据集配置文件 BVN.yaml
path: ./dataset  # 数据集根目录（相对YOLOv5 master项目路径）
train: images/train  # 训练集图片路径（相对于path）
val: images/val      # 验证集图片路径（相对于path）
test:                # 测试集（可选，本次不配置）

# 类别映射（仅保留daitu、mingren两类）
names:
  0: mingren
  1: daitu
```

说明：路径采用相对路径，无需追溯上级目录，确保 `dataset` 文件夹已放入 YOLOv5 根目录。

### 3. 参数指定方式

1. 命令行指定（临时生效）：训练时在命令中直接携带参数，示例如下：
        `python train.py --weights yolov5s.pt --data data/` `bvn` `.yaml`

2. 配置文件修改（永久生效）：直接编辑 `train.py`，将默认参数 `--data` 对应的路径改为 `data/` `bvn` `.yaml`，无需每次命令行输入。

## 三、模型训练启动与过程监控

### 1. 启动训练

在激活的 yolov5 虚拟环境中，进入 YOLOv5 根目录，执行上述训练命令，系统将自动完成以下操作：

- 打印参数配置、系统环境、模型结构、优化器等信息；

- 提示可通过 TensorBoard 查看训练日志；

- 扫描训练集、验证集数据，生成缓存文件，随后启动训练。

### 2. TensorBoard 日志监控

训练过程中可通过 TensorBoard 实时查看指标变化，操作步骤如下：

```Bash

# 启动TensorBoard，指定日志目录（runs/train）
tensorboard --logdir=runs/train
```

启动后，终端将显示访问地址 `localhost:6006`，按住 Ctrl 点击地址，浏览器打开后可查看：

- 训练/验证集损失变化（box loss、classes loss、object loss）；

- 各类评估指标趋势（MAP50 等）；

- 模型结构可视化（graphs）；

- 多轮训练结果对比（如 EXP2、EXP3 等）。

终止 TensorBoard：命令行按 `Ctrl+C` 即可退出。

## 四、训练常见问题及解决方案

### 1. Arial.ttf 字体文件无法下载（卡顿）

- 问题现象：训练时长时间卡在字体下载步骤，进度缓慢；

- 解决方案：手动下载 Arial.ttf 字体，放置于 Windows 对应目录：
        `C:/Users/用户名/AppData/Roaming/Ulralytics`

- 说明：训练时终端会提示具体下载路径，按路径放置字体即可。

### 2. 页面文件太小，无法完成操作

- 问题原因：内存不足，或环境安装在非系统盘（如D盘）导致虚拟内存不足；

- 解决方案：

    1. 调整训练参数 `workers=1`（减少内存占用）；

    2. 修改虚拟内存：

        - 打开「设置」→「系统」→「关于」→「高级系统设置」；

        - 点击「性能」→「设置」→「高级」→「虚拟内存」；

        - 取消「自动管理所有驱动器的分页文件大小」，选中环境安装所在盘（如D盘）；

        - 设置自定义大小（50000~100000 MB），点击「设置」→「确定」，重启电脑生效。

### 3. Upsample object has no attribute 'recompute_scale_factor'

- 问题原因：PyTorch 版本过高，与 YOLOv5 不兼容；

- 解决方案（二选一）：

    1. 降低 PyTorch 版本至 1.8.2（推荐，无报错稳定版本，前文环境已适配）；

    2. 修改 PyTorch 源码：打开报错的 `upsampling.py` 文件，删除对应行的 `recompute_scale_factor` 参数，忽略编辑器危险提示，保存即可。

## 五、训练结果分析与文件说明

### 1. 训练结果核心指标

本次实操训练 100 轮后，核心指标如下（供参考）：

- 整体指标：MAP50 = 0.936（模型整体检测精度优秀）；

- 单项指标：mingren 类别精度 0.96，daitu 类别精度略低，存在类别检测差异。

### 2. 训练结果文件（保存于 runs/train/EXP* 目录）

|文件/文件夹|作用|
|---|---|
|`weights/best.pt`|训练过程中性能最优的模型权重（优先选用）|
|`weights/last.pt`|最后一轮训练的模型权重（备用）|
|`events.out.tfevents*`|TensorBoard 日志文件，用于复盘训练过程|
|`results.csv`|记录每一轮训练的各项指标，支持自定义绘图分析|
|`results.png`|自动生成的指标整合图，直观展示各项指标变化趋势|
|`labels/`|数据集类别分布、比例等统计信息|
## 六、训练后模型检测实操

使用训练得到的最优权重 `best.pt` 对视频进行检测，验证模型效果，命令完全复刻实操代码：

```Bash

python detect.py --weights runs/train/EXP2/weights/best.pt --source ./dataset/BVN.mp4 --view-img
```

### 参数说明

- `--weights`：指定训练生成的最优权重文件路径；

- `--source`：指定检测目标（本次为数据集下的 BVN.mp4 视频）；

- `--view-img`：实时可视化检测结果，弹窗显示每帧检测效果。

### 检测结果与终止方式

- 效果：简单场景下检测准确，动态特效较多时精度略有下降，整体表现良好；

- 终止检测：不可直接关闭弹窗，需在命令行按 `Ctrl+C` 终止程序。