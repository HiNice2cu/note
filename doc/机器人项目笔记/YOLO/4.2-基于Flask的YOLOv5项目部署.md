# 基于Flask的YOLOv5项目部署

## 一、前置说明与核心准备

### 1. 部署核心目标

通过Flask框架搭建REST API服务，实现YOLOv5模型的远程调用，支持两种预测方式：基于文件的预测（官方已提供示例）、基于图像字节流的预测（适配内存中读取的图片/视频帧），核心依赖YOLOv5的hub加载功能与OpenCV的图像编码解码工具。

### 2. 环境依赖

- 基础环境：Python 3.8.x、YOLOv5 项目环境（已配置PyTorch、OpenCV等依赖）

- 核心框架：Flask（用于搭建API服务）

- 工具库：OpenCV（图像编码解码）、numpy（字节流转换）

- 模型要求：YOLOv5系列模型（示例使用YOLOv5s，加载机制适配本地模型）

### 3. 官方示例位置

YOLOv5项目中已内置Flask部署示例，路径为：`utils/flask_rest_api`，核心文件为REST API相关代码，可直接复制到项目根目录修改使用，无需从零编写。

## 二、核心操作：代码迁移与修改

### 第一步：代码迁移

1. 将 `utils/flask_rest_api` 目录下的除README.md所有文件，复制到YOLOv5项目根目录（必须放在根目录，因需调用 `hub.load` 加载模型，需明确路径）。

2. 迁移目的：确保模型加载时能找到 `hubconf.py` 文件，避免因路径错误导致加载失败。

### 第二步：修改REST API代码（适配本地模型）

核心修改点：替换模型加载方式为本地加载，保留其他核心逻辑。

#### 1. 模型加载部分修改

```Python
# 本地加载YOLOv5模型，适配自定义模型
# ./ 表示当前根目录（需包含hubconf.py，否则无法加载模型）
# m 为模型名称，source="local" 指定本地加载，无需联网
models[m] = torch.hub.load("./", m, source="local")
```

修改说明：`source="local"` 指定加载本地模型，无需联网；`path` 为本地模型路径（可替换为自定义训练的 `best.pt`），YOLOv5s模型可直接加载，无需额外配置。

#### 2. 新增基于图像字节流的预测接口（适配内存中图片/视频帧）

需添加对POST请求中`data`字段的处理，使用OpenCV完成字节流与图像的转换（代码从原文提取，无修改）：

```Python
import numpy as np
import cv2

# 读取请求中的图像字节流数据（适配内存中图片/视频帧）
if request.data:
    # 字节流转换为numpy数组（uint8格式，对应图像像素范围）
    # 解码numpy数组为OpenCV图像，cv2.IMREAD_COLOR表示读取彩色图像
    img = cv2.imdecode(np.frombuffer(request.data, np.uint8), cv2.IMREAD_COLOR)
    # 检查模型是否已加载（避免模型未初始化报错）
    if model in models:
        # 调用模型进行预测
        results = models[model](img) 
        # 以JSON格式返回预测结果（XYXY坐标，适配前端/其他服务调用）
        return results.pandas().xyxy[0].to_json(orient="records")
```

#### 3. 可选优化：返回标注后的图像

若需服务返回带检测框的图像，修改接口返回逻辑（代码从原文提取，无修改）：

```Python
# 读取请求中的图像字节流数据
if request.data:
    # 字节流转numpy数组，再解码为OpenCV彩色图像
    img = cv2.imdecode(np.frombuffer(request.data, np.uint8), cv2.IMREAD_COLOR)
    # 检查模型是否已加载
    if model in models:
        # 调用模型预测，可添加size=320参数缩小图像，提升推理速度
        results = models[model](img)  # reduce size=320 for faster inference
        # 生成带检测框、类别标签的标注图像（render()返回标注后图像列表，取第一个元素）
        results = results.render()[0]
        # 编码标注图像为jpg格式字节流，返回给请求方（适配图像展示场景）
        return cv2.imencode('.jpg', results)[1].tobytes()
```

## 三、服务启动与请求测试

### 1. 两种请求方式（需启动服务后测试）修改example_request.py代码

所有请求需在Flask服务启动后执行，以下为两种核心请求方式及接口测试代码：

#### （1）基于文件的请求

```Python
# 基于文件的请求示例：需修改为本地实际图片路径
# 路径可写相对路径（如当前示例，基于YOLOv5根目录）或绝对路径
image_path = "data/image/test.jpg"
```

#### （2）基于图像字节流的请求

```Python
import pprint  # 用于格式化打印预测结果，便于查看
import cv2     # 用于读取、处理图像
import requests# 用于发送HTTP请求，调用Flask接口

# Flask服务的接口地址（对应模型预测接口，需与服务端一致）
DETECTION_URL = "http://localhost:5000/v1/object-detection/yolov5s"
# 本地测试图像路径（需替换为自己的图像路径）
IMAGE = "data/images/zidane.jpg"

# # 备选：以文件读取方式获取图像字节流（注释可保留，按需切换）
# with open(IMAGE, "rb") as f:
#     image_data = f.read()

# 读取本地图像（OpenCV默认读取为BGR格式）
img = cv2.imread(IMAGE)
# 转换图像通道：BGR转RGB（适配YOLOv5模型输入要求）
img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
# 编码图像为jpg格式字节流（适配接口的字节流请求格式）
img = cv2.imencode('.jpg', img)[1].tobytes()

# 发送POST请求，传入图像字节流，获取预测结果（JSON格式）
response = requests.post(DETECTION_URL, data=img).json()

# 格式化打印预测结果（类别、坐标、置信度等信息）
pprint.pprint(response)
```

#### （3）测试返回图像接口

```Python
# YOLOv5 🚀 by Ultralytics, GPL-3.0 license
"""
Perform test request
测试返回标注图像的接口，获取带检测框的图像并展示
"""

import pprint
import cv2     # 图像读取、解码处理
import requests# 发送HTTP请求
import numpy as np  # 字节流与图像转换
import matplotlib.pyplot as plt  # 展示标注后的图像

# Flask服务的预测接口地址（需与服务端一致）
DETECTION_URL = "http://localhost:5000/v1/object-detection/yolov5s"
# 本地测试图像路径（按需替换）
IMAGE = "data/images/zidane.jpg"

# 读取本地图像（BGR格式）
img = cv2.imread(IMAGE)
# BGR转RGB，适配YOLOv5模型输入
img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
# 编码为jpg字节流，用于接口请求
img = cv2.imencode('.jpg', img)[1].tobytes()

# 发送POST请求，传入字节流，获取返回的标注图像字节流
response = requests.post(DETECTION_URL, data=img)

# 解码返回的字节流，转换为OpenCV可处理的图像格式
img = cv2.imdecode(np.frombuffer(response.content, np.uint8), cv2.IMREAD_COLOR)

# 用matplotlib展示标注后的图像（含检测框、类别标签）
plt.imshow(img)
plt.show()
```

### 2. 启动Flask服务

```Bash
# 启动Flask服务，运行restapi.py脚本（需在YOLOv5根目录执行）
# 服务默认监听5000端口，启动后可通过接口发送预测请求
python restapi.py
```

启动成功提示：服务运行在本地5000端口（`http://0.0.0.0:5000`），按`Ctrl+C`可退出服务，启动后即可执行上述请求测试。