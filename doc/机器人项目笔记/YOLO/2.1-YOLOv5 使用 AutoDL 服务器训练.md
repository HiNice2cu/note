# YOLOv5 使用 AutoDL 服务器训练

## 一、AutoDL 服务器基础操作

### 1. 平台访问与登录

1. 访问地址：百度搜索「AutoDL」，进入官方网站（`www.autodl.com`），完成注册并登录（注册流程略，需自行充值余额以租用算力）。

2. 登录后进入控制台，默认显示「机器实例」页面，初始无运行实例，需先租用算力。

### 2. 算力租用（GPU 选择）

#### 核心选择逻辑

进入「算力市场」，按需求选择显卡型号、租赁方式及地区，关键要点如下：

- 租赁方式：支持按量计费、包日、包周、包月，演示场景推荐「按量计费」，灵活控制成本。

- 地区选择：无特殊要求，优先选择有可用卡、延迟较低的地区即可。

- 显卡型号：根据数据量和需求选择，演示场景可选 RTX 3080、RTX 2080Ti；大批次训练可选择 V100、RTX 3090，多卡训练需在「GPU」选项中选择对应数量（如选 2 即支持双卡训练）。

#### 租用实操步骤

1. 在算力列表中筛选可用显卡（标注「1卡可租」「网盘支持」），选择 RTX 2080Ti 或 3080，点击进入配置页。

2. 数据盘配置：默认提供 50GB 数据盘，数据量不大时无需扩容；若数据集过大，需确认机器支持后再扩容。

3. 镜像选择（关键坑点）：

    - ❌ 禁止选择 YOLOv5 算法镜像：虽可运行，但训练结果分数会为 0，完全无效。

    - ✅ 选择基础镜像：选「PyTorch」镜像，版本推荐 PyTorch 1.9+、Python 3.8、CUDA 11.1；若租用 30 系列显卡，CUDA 版本必须 ≥11.0，否则不兼容。

4. 点击「立即创建」，等待服务器启动（约 1-2 分钟），启动后状态显示「运行中」。

### 3. 服务器连接（Jupyter Lab）

服务器启动后，点击实例后的「Jupyter Lab」，自动在浏览器中打开交互界面，左侧为文件列表，右侧可创建代码块或启动终端，用于后续环境配置和训练操作。

## 二、服务器环境配置（YOLOv5 部署）

### 1. 项目代码与文件上传

1. 上传 YOLOv5 代码：将本地下载的 YOLOv5 master 分支代码（压缩包或文件夹），通过 Jupyter Lab 左侧「上传文件」按钮拖拽上传，或点击「Upload」选择文件上传。

2. 上传预训练模型：将 `yolov5s.pt` 模型文件上传至服务器（与 YOLOv5 代码同级目录），用于后续检测验证。

3. 上传数据集：将数据集压缩为 ZIP 文件（清理无关内容，如 `coco128` 文件夹），上传至服务器后解压使用。

### 2. 代码解压与环境激活

在 Jupyter Lab 中启动终端，执行以下命令（代码完全复刻实操）：

```Bash
# 解压 YOLOv5 代码压缩包（文件名按实际上传的修改）
unzip yolov5-master.zip

# 进入项目目录
cd yolov5-master

# 初始化环境（解决镜像环境未激活问题）
conda init

# 退出终端并重新启动（重启后环境自动激活）
exit
```

重新启动终端后，再次进入 `yolov5-master` 目录，执行依赖安装命令。

### 3. 依赖包安装

```Bash
# 安装项目依赖
pip install -r requirements.txt
```

#### 常见报错与解决方案

执行上述命令可能报错「Python 无法找到 TQDM 版本 >4.64.0」，解决方案：

1. 打开 `requirements.txt` 文件，将 TQDM 版本从「tqdm>=4.64.0」改为「tqdm>=4.63.0」。

2. 保存后重新执行 `pip install -r requirements.txt`，即可正常安装（4.63.0 版本满足兼容性要求）。

### 4. 检测验证环境

依赖安装完成后，执行检测命令验证环境是否正常：

```Bash
python detect.py
```

若快速输出检测结果，且与本地 Windows 环境结果一致，说明服务器环境配置成功。

## 三、模型训练与关键问题处理

### 1. 数据集解压与配置文件修改

```Bash
# 解压数据集（文件名按实际上传的修改）
unzip dataset.zip

# 复制并修改数据集配置文件
cp data/coco128.yaml data/BVN.yaml
```

打开 `data/BVN.yaml`，修改路径与类别（适配数据集）：

```yaml
path: ./dataset  # 数据集根目录（相对项目路径）
train: images/train
val: images/val
test:

names:
  0: mingren
  1: daitu
```

修改train.py文件,修改`--data`参数的默认值，使其指向自定义的`bvn.yaml`配置文件，避免每次训练手动指定路径，代码如下：

```Python
parser.add_argument('--data', type=str, default=ROOT / 'data/bvn.yaml', help='dataset.yaml path')
```

修改后，训练时程序将自动加载`data/bvn.yaml`中的数据集配置，无需额外在命令行补充`--data`参数，适配自定义的`mingren`和`daitu`两类目标数据集。

### 2. 启动训练与字体问题解决

```Bash
python train.py
```

#### 字体下载卡顿解决方案

训练时可能卡顿在「字体下载」步骤，因服务器网络不稳定，需手动上传字体文件：

1. 本地下载 Arial.ttf 字体文件，上传至服务器。

2. 在终端执行命令，将字体移动至指定目录：`mv Arial.ttf /root/.config/Ulralytics/`

3. 重新执行`python train.py`，训练正常启动，且速度显著快于本地。

## 四、训练结果打包与本地下载

### 1. 结果打包（解决文件夹无法直接下载问题）

训练完成后，`runs/train/` 目录下生成训练结果（如 EXP2、EXP3），因 Jupyter Lab 无法直接下载文件夹，需先打包：

```Bash
# 打包训练结果
tar -cvf runs.tar.gz runs/
```

### 2. 本地下载与使用

1. 在 Jupyter Lab 左侧找到 `runs` `.tar.gz` 文件，右键点击选择「Download」，下载至本地。

2. 本地解压后，将 EXP文件夹放入本地 YOLOv5 项目的 `runs/train/` 目录。

3. 修改检测命令中的模型路径，验证服务器训练的模型：
运行hub_detect.ipynb

运行后检测正常，说明训练结果可跨环境复用。

## 五、服务器资源管理（成本控制）

### 1. 关机与资源释放

1. 训练完成并下载结果后，在 AutoDL 控制台找到对应实例，点击「关机」。

2. 关机后将停止计费，避免长时间占用资源导致成本浪费。

## 六、整体流程回顾

### 1. 核心流程

AutoDL 登录 → 算力租用（选对镜像）→ 代码/数据集上传 → 环境激活与依赖安装 → 模型训练（解决字体问题）→ 结果打包下载 → 服务器关机。