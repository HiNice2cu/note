# YOLOv5 替换主干网络（以 MobileNetV3 为例）

### 一、前置核心原则与准备工作

#### 1. 替换核心原则

YOLOv5 的 head 部分依赖 backbone 输出的 3 个关键尺度特征图，替换主干网络后需满足：

- 必须保留 **8倍下采样（80×80）**、**16倍下采样（40×40）**、**32倍下采样（20×20）** 的特征输出。

- 仅替换 backbone，head 部分可复用（只需调整 `from` 参数指向新的特征层），无需重构。

#### 2. 代码借鉴与依赖准备

##### （1）代码借鉴来源

```Plain Text
# MobileNet 代码来源：PyTorch 内置 torchvision 库
# 无需额外下载，直接通过 torchvision.models 调用
import torchvision.models as models
```

##### （2）依赖安装

```Bash
# 安装模型结构可视化工具（查看 MobileNet 特征图输出）
pip install torchinfo
```

##### （3）MobileNet 结构分析（关键步骤）

通过 `torchinfo` 可视化 MobileNetV3-Small 结构，确认其特征图下采样与通道数：

```Python
# 从原文提取的结构分析代码（无任何修改）
import torch
import torchvision.models as models
from torchinfo import summary

# 加载 MobileNetV3-Small 预训练模型
model = models.mobilenet_v3_small(pretrained=True, progress=True)

# 可视化结构（输入尺寸：1×3×640×640，与 YOLOv5 一致）
summary(model, input_size=(1, 3, 640, 640))
```

- 关键发现：MobileNetV3-Small 的特征提取层（`model.features`）天然包含 3 个关键尺度：

    - 8倍下采样（80×80）：前 4 个模块输出（通道数 24）。

    - 16倍下采样（40×40）：第 4-9 个模块输出（通道数 48）。

    - 32倍下采样（20×20）：第 9 个模块后输出（通道数 576）。

### 二、替换主干网络全流程（4步完成）

核心修改顺序：  

`models/commons.py` → 加入 MobileNet 模块 → `models/yolov5*.yaml` → 替换 backbone+调整 `from` 参数 → `models/yolo.py` → 配置传参细节 → `train.py` → 训练时指定配置文件

#### 第一步：修改 models/[commons.py](commons.py)（定义 MobileNet 模块）

1. 打开 `models/commons.py`，添加 MobileNetV3-Small 模块（利用切片复用预训练特征提取层）：

```Python
# 从原文提取的 MobileNetV3 模块（无修改）
import torch
import torch.nn as nn
import torchvision.models as models

class MobileNetV3(nn.Module):
    def __init__(self, slice):
        super(MobileNetV3, self).__init__()
        # 加载预训练 MobileNetV3-Small
        self.model = None
        # 根据 slice 参数选择特征提取层片段
        if slice == 1:
            # 片段1：前4个模块，输出 8倍下采样（80×80，通道24）
            self.features = self.model.features[:4]
        elif slice == 2:
            # 片段2：第4-9个模块，输出 16倍下采样（40×40，通道48）
            self.features = self.model.features[4:9]
        else:
            # 片段3：第9个模块后，输出 32倍下采样（20×20，通道576）
            self.features = self.model.features[9:]
    
    def forward(self, x):
        return self.features(x)
```

#### 第二步：修改 models/yolov5*.yaml（替换 backbone+调整层编号）

1. 复制 `models/yolov5s.yaml`，重命名为 `yolov5s_mobilenet.yaml`。

2. 替换 backbone 部分（删除原有 C3/Conv 结构，添加 MobileNet 片段）：

```YAML
# 修改后的 backbone 配置
nc: 80
depth_multiple: 0.33
width_multiple: 0.50
anchors:
  - [10,13, 16,30, 33,23]
  - [30,61, 62,45, 59,119]
  - [116,90, 156,198, 373,326]

# 替换后的 backbone：3个 MobileNet 片段，对应 3个关键尺度
backbone:
  [[-1, 1, MobileNetV3, [24,1]],  # 片段0：输出 80×80（8倍下采样），通道24
   [-1, 1, MobileNetV3, [48,2]],  # 片段1：输出 40×40（16倍下采样），通道48
   [-1, 1, MobileNetV3, [576,3]],  # 片段2：输出 20×20（32倍下采样），通道576
  ]

# head 部分仅调整 from 参数（适配新 backbone 层编号）
head:
  [[-1, 1, Conv, [512, 1, 1]],                       #3-20*20
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],       #4-40*40
   [[-1, 1], 1, Concat, [1]],  # cat backbone p1,     5-40*40
   [-1, 3, C3, [512, False]],                        #6-40*40

   [-1, 1, Conv, [256, 1, 1]],                       #7-40*40
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],       #8-80*80
   [[-1, 0], 1, Concat, [1]],  # cat backbone P0,     9-80*80
   [-1, 3, C3, [256, False]],                        #10-80*80

   [-1, 1, Conv, [256, 3, 2]],                       #11-40*40
   [[-1, 7], 1, Concat, [1]],  # cat head P7          12-40*40
   [-1, 3, C3, [512, False]],                        #13-40*40

   [-1, 1, Conv, [512, 3, 2]],                        #14-20*20
   [[-1, 3], 1, Concat, [1]],  # cat head P3           15-20*20
   [-1, 3, C3, [1024, False]],                        #16-20*20

   [[10, 13, 16], 1, Detect, [nc, anchors]],  # Detect(P3, P4, P5)
  ]
```

1. 关键调整：head 中所有 Concat`from` 参数需根据新 backbone 层编号重新映射。

#### 第三步：修改 models/[yolo.py](yolo.py)（配置 MobileNet 传参细节）

1. 打开 `models/yolo.py`，找到 `parse_model` 函数，新增 MobileNetV3 的传参逻辑：

```Python
elif m is MobileNetV3:
            c2 = args[0]
            args = args[1:]
```

#### 第四步：修改 [train.py](train.py)（指定新配置文件）

1. 打开 `train.py`，修改 `--cfg` 参数默认值，指向 MobileNet 配置文件：

```Python
# 从原文提取的修改后代码（无任何更改）
parser.add_argument('--cfg', type=str, default=ROOT / 'models/yolov5s_mobilenet.yaml', help='model.yaml path')
```
