# YOLOv5 Torchhub 模型预测进阶

### 一、核心基础：模型加载

#### 1. 加载核心代码

```Python
model = torch.hub.load("./","custom", path="runs/train/exp2/weights/best.pt", source="local")
```

#### 2. 加载参数详解

- `"./"`：模型所在路径，必须是 YOLOv5 项目根目录（需包含 `hubconf.py` 文件，否则报错）。

- `"custom"`：固定关键字，用于加载自定义训练模型，不可替换为其他值。

- `path="runs/train/exp2/weights/best.pt"`：模型文件路径（支持 `.pt` 原生模型、`.engine` TensorRT 模型）。

- `source="local"`：加载来源，仅支持 `github` 或 `local` 两种类型，本地模型必须设为 `local`。

#### 3. 加载流程与依赖

- 底层逻辑：通过 `hubconf.py` 中的 `custom()` 函数创建模型，自动处理 `auto_shape` 封装，支持多格式输入。

- 关键依赖：必须在包含 `hubconf.py` 的 YOLOv5 根目录运行代码，否则会因找不到配置文件加载失败。

- 官方模型加载：若加载官方预训练模型（如 `yolov5n.pt`、`yolov5m.pt`），可直接指定模型名称，无需 `path` 参数（需联网下载）。

### 二、灵活预测：支持多格式输入

#### 1. 预测核心代码

```Python
# 模型预测（支持多种输入格式）
results = model(image)
```

#### 2. 支持的输入类型（无需额外预处理）

- 文件类：本地图片路径（如 `"./test.jpg"`）、视频路径（如 `"./test.mp4"`）。

- 网络类：在线图片 URI（如 `"https://xxx.jpg"`）。

- 数据类：OpenCV 读取的 `numpy` 数组、PIL 图片对象、PyTorch 张量。

### 三、结果解析：5 种常用结果处理方法

所有结果均基于 `results` 对象（YOLOv5 封装的 `Detections` 类），支持以下方法，代码从原文提取：

#### 1. 图片可视化（直接显示检测结果）

```Python
# 弹出窗口显示带标注的图片
results.show()
```

#### 2. 图片结果（获取标注后的图像数据）

```Python
# 返回标注后的图像张量（可直接保存或转换为 PIL/OpenCV 格式）
annotated_img = results.render()[0]
```

#### 3. 数据结果（获取检测坐标与类别信息）

```Python
# 返回 DataFrame 格式数据，支持 4 种坐标类型
# 坐标类型：xyxy（左上-右下坐标）、xyxyn（归一化 xyxy）、xywh（中心-宽高）、xywhn（归一化 xywh）
data = results.pandas().xyxy[0]  # 推荐使用 xyxy 格式，直观易懂
print(data[["xmin", "ymin", "xmax", "ymax", "name", "confidence"]])
```

#### 4. 裁切结果（单独提取检测目标）

```Python
# 返回列表，每个元素为字典（包含 box 坐标、confidence 置信度、class 类别、im 裁切图像）
crops = results.crops
# 示例：保存第一个检测目标的裁切图
crops[0]["im"].save("crop_0.jpg")
```

#### 5. 文本结果（打印检测信息）

```Python
# 终端打印检测结果（类别、置信度、坐标）
results.print()
# 提取文本字符串（用于日志或界面显示）
text_result = str(results)
```

### 四、特殊适配：TensorRT 模型加载与问题解决

#### 1. TensorRT 模型加载代码

```Python
# 加载 TensorRT 模型（.engine 格式）
model = torch.hub.load("./", "custom", path="yolov5s.engine", source="local")
```

#### 2. 两大关键问题解决

##### （1）输入维度不匹配报错

- 问题：Torchhub 不会自动调整图像尺寸为 640×640（`detect.py` 会自动调整），可能导致维度不匹配。

- 解决方案：加载与输入尺寸匹配的 TensorRT 模型（如 FP16/FP32 格式，确保模型输入维度与图像维度一致）。

##### （2）类别名称显示异常（class 0、class 27 等）

- 问题：TensorRT 模型默认未加载类别名称，仅显示类别索引。

- 解决方案：手动指定类别名称映射，代码如下（从原文提取）：

```Python

# 手动设置类别名称（以 COCO 数据集为例，按需修改）
model.names = {0: "person", 27: "tie", ...}  # 索引对应类别名称
```